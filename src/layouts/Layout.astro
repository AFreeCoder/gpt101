---
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';
import StructuredData from '~/components/common/StructuredData.astro';

// Comment the line below to disable View Transitions
import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';

export interface Props {
  metadata?: MetaDataType;
  structuredDataType?: 'product' | 'faq' | 'all';
}

const { metadata = {}, structuredDataType } = Astro.props;
const { language, textDirection } = I18N;
---

<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons />
    <script is:inline>
      (function () {
        if (!('fetch' in window) || window.__assetFetchCachePatched) return;

        window.__assetFetchCachePatched = true;

        const originalFetch = window.fetch.bind(window);
        const cache = new Map();
        const targets = new Set(['/favicon.png', '/logo-32.png', '/qq-qrcode.png']);

        const resolveTarget = (input) => {
          try {
            const url =
              typeof input === 'string'
                ? new URL(input, window.location.href)
                : new URL(input.url, window.location.href);
            return targets.has(url.pathname) ? url.pathname : null;
          } catch {
            return null;
          }
        };

        window.fetch = async function patchedFetch(input, init) {
          const key = resolveTarget(input);

          if (key && cache.has(key)) {
            return cache.get(key).clone();
          }

          const response = await originalFetch(input, init);

          if (key && response.ok) {
            cache.set(key, response.clone());
          }

          return response;
        };
      })();
    </script>
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Structured Data (Schema.org JSON-LD) -->
    {structuredDataType && <StructuredData type={structuredDataType} />}

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />
  </head>

  <body class="antialiased text-default bg-page tracking-tight">
    <slot />

    <BasicScripts />
  </body>
</html>
