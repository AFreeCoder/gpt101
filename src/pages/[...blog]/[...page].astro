---
import type { InferGetStaticPropsType, GetStaticPaths } from 'astro';

import { SITE } from 'astrowind:config';

import Layout from '~/layouts/PageLayout.astro';
import BlogList from '~/components/blog/List.astro';
import Pagination from '~/components/blog/Pagination.astro';
import { siteConfig } from '~/config/site';

import { blogListRobots, getStaticPathsBlogList, fetchPosts } from '~/utils/blog';
import { getCanonical, getPermalink } from '~/utils/permalinks';
import type { Post } from '~/types';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  return await getStaticPathsBlogList({ paginate });
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { page } = Astro.props as Props;
const currentPage = page.currentPage ?? 1;
const allPosts = await fetchPosts();

type TutorialCategory = {
  slug: string;
  title: string;
  description: string;
  href: string;
  icon: string;
  keywords: readonly string[];
};

const tutorialCategories: TutorialCategory[] = [
  {
    slug: 'plus',
    title: 'Plus ä»£å……æ•™ç¨‹',
    description: 'è´­ä¹°å¡å¯†ã€éªŒè¯è´¦å·ã€å‘ç¥¨ç­‰æœ€å¸¸è§é—®é¢˜éƒ½åœ¨è¿™é‡Œã€‚',
    href: '/how-to-upgrade-gpt-plus',
    icon: 'âš¡',
    keywords: ['Plus', 'å……å€¼', 'å¡å¯†'],
  },
  {
    slug: 'mirror',
    title: 'é•œåƒæœåŠ¡ä½“éªŒ',
    description: 'å›½å†…ç›´è¿é•œåƒä½¿ç”¨æ­¥éª¤ã€å¥—é¤è¯´æ˜ã€å¸¸è§é™åˆ¶è¯´æ˜ã€‚',
    href: '/chatgpt-mirror-guide',
    icon: 'ğŸª',
    keywords: ['é•œåƒ', 'Mirror'],
  },
  {
    slug: 'payment',
    title: 'æ”¯ä»˜ä¸é¿å‘',
    description: 'æ”¯ä»˜æ–¹å¼ã€é€€æ¬¾æœºåˆ¶ã€å°å·å¤„ç†ç­‰ç»éªŒåˆ†äº«ã€‚',
    href: '/2025-latest-7-way-to-upgrade-chatgpt-plus',
    icon: 'ğŸ›¡ï¸',
    keywords: ['é¿å‘', 'ChatGPTå……å€¼'],
  },
] as const;

const normalizeMatch = (value: string) => value.toLowerCase();

const matchByCategorySlug = (post: Post, slug: string) => {
  if (!post.category || !post.category.slug) {
    return false;
  }
  return normalizeMatch(post.category.slug) === normalizeMatch(slug);
};

const categoriesWithStats = tutorialCategories.map((category) => {
  const belongsToCategory = (post: Post) => {
    if (matchByCategorySlug(post, category.slug)) {
      return true;
    }
    const tags = post.tags || [];
    return tags.some((tag) =>
      category.keywords.some((keyword) => normalizeMatch(tag.title || '').includes(normalizeMatch(keyword)))
    );
  };

  const count = allPosts.filter(belongsToCategory).length;
  const featuredPost = allPosts.find(belongsToCategory);

  return {
    ...category,
    count,
    featuredTitle: featuredPost?.title,
    featuredUrl: featuredPost ? getPermalink(featuredPost.permalink, 'post') : category.href,
  };
});

const featuredPosts = allPosts.slice(0, 2);

const metadata = {
  title: `æ•™ç¨‹ä¸­å¿ƒ${currentPage > 1 ? ` ï½œ ç¬¬ ${currentPage} é¡µ` : ''}`,
  robots: {
    index: blogListRobots?.index && currentPage === 1,
    follow: blogListRobots?.follow,
  },
  openGraph: {
    type: 'blog',
  },
};

const tutorialsPath = siteConfig.navigation.links.blog;
const tutorialsCanonical = getCanonical(getPermalink(tutorialsPath));
const currentPath = page.url?.current || tutorialsPath;
const currentCanonical = getCanonical(getPermalink(currentPath));

const breadcrumbList = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'é¦–é¡µ',
      item: SITE?.site,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'æ•™ç¨‹ä¸­å¿ƒ',
      item: tutorialsCanonical,
    },
    ...(currentPage > 1
      ? [
          {
            '@type': 'ListItem',
            position: 3,
            name: `æ•™ç¨‹ä¸­å¿ƒç¬¬${currentPage}é¡µ`,
            item: currentCanonical,
          },
        ]
      : []),
  ],
};

const faqStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: [
    {
      '@type': 'Question',
      name: 'æ²¡æœ‰æµ·å¤–ä¿¡ç”¨å¡ä¹Ÿèƒ½å‡çº§ ChatGPT Plus å—ï¼Ÿ',
      acceptedAnswer: {
        '@type': 'Answer',
        text: 'å¯ä»¥ã€‚æ•™ç¨‹ä¸­å¿ƒæä¾›çš„æ‰€æœ‰ Plus ä»£å……æ–¹æ¡ˆéƒ½æ”¯æŒå¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜ï¼Œé€šè¿‡è‹¹æœè®¢é˜…é€šé“å®Œæˆå……å€¼ï¼Œæ— éœ€æµ·å¤–ä¿¡ç”¨å¡ã€‚',
      },
    },
    {
      '@type': 'Question',
      name: 'å……å€¼æˆ–é•œåƒä½“éªŒå¤±è´¥ä¼šæ€ä¹ˆåŠï¼Ÿ',
      acceptedAnswer: {
        '@type': 'Answer',
        text: 'å¦‚é‡å……å€¼å¤±è´¥æˆ–æœåŠ¡å¼‚å¸¸ï¼Œæˆ‘ä»¬ä¼šæŒ‰é€€æ¬¾æ”¿ç­–å¤„ç†ï¼›å¦‚è®¢å•å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡è®¢å•æŸ¥è¯¢å…¥å£æˆ–ç›´æ¥è”ç³»å®¢æœ QQ 2316149029 å¤„ç†ã€‚',
      },
    },
  ],
};
---

<Layout metadata={metadata}>
  <section class="relative overflow-hidden bg-gradient-to-r from-blue-50 to-indigo-50">
    <div class="mx-auto max-w-5xl px-6 py-16">
      <p class="text-sm font-semibold uppercase tracking-[0.3em] text-blue-600">æ•™ç¨‹ä¸­å¿ƒ</p>
      <h1 class="mt-4 text-4xl font-bold leading-tight text-gray-900 sm:text-5xl">
        ChatGPT Plus ä»£å…… & é•œåƒæœåŠ¡ä½¿ç”¨æŒ‡å—
      </h1>
      <p class="mt-4 text-lg text-gray-600 sm:text-xl">
        æ”¶å½•æœ€å¸¸è§çš„å……å€¼æ­¥éª¤ã€é•œåƒä½“éªŒã€æ”¯ä»˜é¿å‘ã€å”®åä¿éšœç­‰é«˜æ„å›¾æ•™ç¨‹ï¼Œå¸®åŠ©ä½ é€šå¸¸1-2åˆ†é’Ÿå®Œæˆå‡çº§ã€0é—¨æ§›ä½¿ç”¨ GPT-5ã€‚
      </p>
      <div class="mt-6 flex flex-col gap-3 sm:flex-row">
        <a
          class="inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-green-500 to-blue-500 px-5 py-3 text-base font-semibold text-white shadow-md transition hover:shadow-lg"
          href={siteConfig.homepage.links.cardPurchase}
          target="_blank"
          rel="noopener noreferrer"
          data-ga-event="tutorials_hero_cta"
          data-ga-label="hero_plus_purchase"
        >
          ç«‹å³è´­ä¹° Plus
        </a>
        <a
          class="inline-flex items-center justify-center rounded-2xl border border-gray-200 px-5 py-3 text-base font-semibold text-gray-700 transition hover:border-gray-300 hover:text-primary"
          href={siteConfig.homepage.links.mirrorExperience}
          data-ga-event="tutorials_hero_cta"
          data-ga-label="hero_mirror_experience"
        >
          é•œåƒæœåŠ¡ä½“éªŒ
        </a>
      </div>
    </div>
  </section>

  <section class="mx-auto max-w-5xl px-6 py-12">
    <div class="grid gap-6 md:grid-cols-3">
      {
        categoriesWithStats.map((category) => (
          <a
            href={category.featuredUrl}
            class="group relative rounded-3xl border border-gray-100 bg-white/90 p-6 shadow-sm transition hover:-translate-y-1 hover:shadow-xl"
          >
            <div class="text-3xl">{category.icon}</div>
            <h3 class="mt-4 text-xl font-bold text-gray-900">{category.title}</h3>
            <p class="mt-2 text-sm text-gray-500">{category.description}</p>
            <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
              <span>ç›¸å…³æ–‡ç«  {category.count}</span>
              <span class="inline-flex items-center gap-1 text-primary">
                æŸ¥çœ‹
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </span>
            </div>
          </a>
        ))
      }
    </div>
  </section>

  {
    featuredPosts.length > 0 && (
      <section class="mx-auto max-w-5xl px-6 pb-4">
        <div class="mb-6 flex items-center justify-between">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-blue-600">ç²¾é€‰æ¨è</p>
            <h2 class="mt-2 text-3xl font-bold text-gray-900">çƒ­é—¨æ•™ç¨‹</h2>
          </div>
          <a href="/tutorials" class="text-sm font-semibold text-primary hover:underline">
            æŸ¥çœ‹å…¨éƒ¨
          </a>
        </div>
        <div class="grid gap-6 md:grid-cols-2">
          {featuredPosts.map((post) => (
            <div class="rounded-3xl border border-gray-100 p-6 shadow-sm transition hover:-translate-y-1 hover:shadow-lg">
              <p class="text-sm text-gray-500">
                {post.publishDate.toLocaleDateString('zh-CN', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })}
              </p>
              <a href={getPermalink(post.permalink, 'post')} class="mt-2 block text-2xl font-bold text-gray-900">
                {post.title}
              </a>
              {post.excerpt && <p class="mt-2 text-sm text-gray-600">{post.excerpt}</p>}
              <a
                href={getPermalink(post.permalink, 'post')}
                class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-primary"
              >
                é˜…è¯»æ•™ç¨‹
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
          ))}
        </div>
      </section>
    )
  }

  <section class="mx-auto max-w-4xl px-6 py-12">
    <div class="mb-8 text-center">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-blue-600">å…¨éƒ¨æ•™ç¨‹</p>
      <h2 class="mt-2 text-3xl font-bold text-gray-900">æŒç»­æ›´æ–°çš„å……å€¼ä¸ä½¿ç”¨æŒ‡å—</h2>
    </div>
    <BlogList posts={page.data} />
    <div class="mt-10">
      <Pagination prevUrl={page.url.prev} nextUrl={page.url.next} />
    </div>
  </section>

  <script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbList)} />
  <script type="application/ld+json" is:inline set:html={JSON.stringify(faqStructuredData)} />
  <script is:inline>
    (() => {
      const sendAnalyticsEvent = (action, label) => {
        if (typeof window === 'undefined') return;
        const win =
          /** @type {typeof window & { gtag?: (...args: unknown[]) => void; dataLayer?: Array<Record<string, unknown>>; }} */ (
            window
          );
        const payload = {
          event_category: 'tutorials',
          event_label: label || '',
        };
        if (typeof win.gtag === 'function') {
          win.gtag('event', action, payload);
        } else if (Array.isArray(win.dataLayer)) {
          win.dataLayer.push({ event: action, ...payload });
        }
      };

      const bindAnalytics = () => {
        document.querySelectorAll('[data-ga-event]').forEach((element) => {
          if (element.getAttribute('data-ga-bound') === 'true') {
            return;
          }
          element.setAttribute('data-ga-bound', 'true');
          element.addEventListener('click', () => {
            const action = element.getAttribute('data-ga-event') || 'tutorials_click';
            const label = element.getAttribute('data-ga-label') || '';
            sendAnalyticsEvent(action, label);
          });
        });
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindAnalytics, { once: true });
      } else {
        bindAnalytics();
      }

      document.addEventListener('astro:page-load', bindAnalytics);
    })();
  </script>
</Layout>
