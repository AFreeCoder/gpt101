---
/**
 * 悬浮客服按钮组件
 * 功能：
 * 1. 固定在右下角
 * 2. 点击展开显示客服卡片
 * 3. 显示QQ二维码（如果有）
 * 4. 显示QQ号，支持一键复制
 */

import { siteConfig } from '~/config/site';

// 从配置文件获取客服信息
const { qq: qqNumber, customerService } = siteConfig.contact;
const { title: cardTitle, subtitle: cardSubtitle, qrCode, serviceTime, toast } = customerService;
---

<!-- 悬浮客服按钮 -->
<div class="fixed bottom-6 right-6 z-50 floating-customer-service" data-cs-root data-open="false">
  <!-- 主按钮 -->
  <button
    type="button"
    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-xl"
    aria-label="联系客服"
    aria-expanded="false"
    aria-controls="customer-service-card"
    data-cs-toggle
  >
    <!-- 客服图标 -->
    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
      ></path>
    </svg>

    <!-- 小红点提示（可选） -->
    <span class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
  </button>

  <!-- 客服卡片（点击后展开） - 紧凑版 -->
  <div
    id="customer-service-card"
    data-cs-panel
    class="absolute bottom-20 right-0 w-64 bg-white rounded-xl shadow-2xl overflow-hidden transition-all duration-300"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    aria-labelledby="customer-service-title"
  >
    <!-- 卡片头部 - 精简 -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-4 py-3 text-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <div>
            <h3 id="customer-service-title" class="font-semibold text-base">{cardTitle}</h3>
            <p class="text-xs text-white/80">{cardSubtitle}</p>
          </div>
        </div>
        <button type="button" class="text-white/80 hover:text-white transition-colors" aria-label="关闭" data-cs-close>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- 卡片内容 - 紧凑布局 -->
    <div class="p-4 space-y-3">
      <!-- QQ二维码 - 缩小 -->
      <div class="text-center">
        <p class="text-xs text-gray-600 mb-2 font-medium">{qrCode.label}</p>
        <div class="flex justify-center">
          <img
            src={qrCode.path}
            alt={qrCode.label}
            width="128"
            height="128"
            loading="lazy"
            decoding="async"
            class="w-32 h-32 rounded-lg border border-gray-200"
          />
        </div>
      </div>

      <!-- QQ号 - 紧凑，无重复标签 -->
      <div class="text-center">
        <div class="flex items-center justify-center gap-2">
          <div class="bg-gray-50 border border-gray-200 rounded px-2.5 py-1.5">
            <p class="text-sm font-bold text-gray-900 select-all" data-cs-qq>{qqNumber}</p>
          </div>
          <button
            type="button"
            class="bg-blue-600 hover:bg-blue-700 text-white px-2.5 py-1.5 rounded transition-colors duration-200 flex items-center gap-1"
            aria-label="复制QQ号"
            data-cs-copy
          >
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            <span class="text-xs font-medium">复制</span>
          </button>
        </div>
      </div>

      <!-- 服务时间 - 精简 -->
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-100 rounded-lg p-2.5">
        <div class="flex items-center justify-center gap-1.5 text-blue-800">
          <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-xs font-semibold">{serviceTime.title}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 复制成功提示 -->
  <div
    id="copy-success-toast"
    class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300"
    role="status"
    aria-live="polite"
    data-cs-toast="hidden"
  >
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path
          fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
          clip-rule="evenodd"></path>
      </svg>
      <span class="font-medium">{toast.successMessage}</span>
    </div>
  </div>
</div>

<style>
  .floating-customer-service [data-cs-panel] {
    opacity: 0;
    transform: scale(0.95);
    pointer-events: none;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      transform 0.3s ease,
      visibility 0.3s ease;
  }

  .floating-customer-service[data-open='true'] [data-cs-panel] {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
    visibility: visible;
  }

  .floating-customer-service [data-cs-toast] {
    opacity: 0;
    visibility: hidden;
    transform: translateX(1.5rem);
    pointer-events: none;
  }

  .floating-customer-service [data-cs-toast='visible'] {
    opacity: 1;
    visibility: visible;
    transform: translateX(0);
    pointer-events: auto;
  }

  /* 小红点脉冲动画 */
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* 响应式适配 */
  @media (max-width: 640px) {
    .floating-customer-service {
      bottom: 1rem;
      right: 1rem;
    }

    .floating-customer-service [data-cs-panel] {
      width: calc(100vw - 2rem);
      max-width: 20rem;
    }
  }
</style>

<script>
  (function () {
    const ROOT_SELECTOR = '[data-cs-root]';
    let teardown: (() => void) | null = null;

    function initialize() {
      if (typeof teardown === 'function') {
        teardown();
        teardown = null;
      }

      const root = document.querySelector(ROOT_SELECTOR);
      const panel = root?.querySelector('[data-cs-panel]');
      const toggleBtn = root?.querySelector('[data-cs-toggle]');

      if (!root || !panel || !toggleBtn) {
        return;
      }

      const closeBtn = root.querySelector('[data-cs-close]');
      const copyBtn = root.querySelector('[data-cs-copy]');
      const qqElement = root.querySelector('[data-cs-qq]');
      const toast = document.getElementById('copy-success-toast');
      const qqValue = qqElement?.textContent?.trim() || '';
      const panelId = panel.id || 'customer-service-card';

      if (!panel.id) {
        panel.id = panelId;
      }

      toggleBtn.setAttribute('aria-controls', panelId);
      toggleBtn.setAttribute('aria-expanded', 'false');
      panel.setAttribute('aria-hidden', 'true');
      root.setAttribute('data-open', 'false');

      const disposers: Array<() => void> = [];
      let toastTimer: number | null = null;
      const toastStates = {
        hidden: 'hidden',
        visible: 'visible',
      };

      const addListener = (
        target: EventTarget,
        event: string,
        handler: EventListenerOrEventListenerObject,
        options?: boolean | AddEventListenerOptions
      ) => {
        target.addEventListener(event, handler, options);
        disposers.push(() => target.removeEventListener(event, handler, options));
      };

      const openPanel = () => {
        root.setAttribute('data-open', 'true');
        toggleBtn.setAttribute('aria-expanded', 'true');
        panel.setAttribute('aria-hidden', 'false');
      };

      const closePanel = () => {
        root.setAttribute('data-open', 'false');
        toggleBtn.setAttribute('aria-expanded', 'false');
        panel.setAttribute('aria-hidden', 'true');
      };

      const togglePanel = (event: Event) => {
        event.preventDefault();
        event.stopPropagation();

        if (root.getAttribute('data-open') === 'true') {
          closePanel();
        } else {
          openPanel();
        }
      };

      const handleClose = (event: Event) => {
        event.preventDefault();
        event.stopPropagation();
        closePanel();
      };

      const handleDocumentClick = (event: Event) => {
        if (root.getAttribute('data-open') !== 'true') {
          return;
        }

        const target = event.target as Node | null;
        if (target && !root.contains(target)) {
          closePanel();
        }
      };

      const handleKeydown = (event: KeyboardEvent) => {
        if (event.key === 'Escape' && root.getAttribute('data-open') === 'true') {
          closePanel();
        }
      };

      const hideToast = () => {
        if (!toast) {
          return;
        }

        toast.setAttribute('data-cs-toast', toastStates.hidden);
      };

      const showToast = () => {
        if (!toast) {
          return;
        }

        toast.setAttribute('data-cs-toast', toastStates.visible);

        if (toastTimer) {
          clearTimeout(toastTimer);
        }

        toastTimer = window.setTimeout(() => {
          hideToast();
          toastTimer = null;
        }, 3000);
      };

      const fallbackCopy = () => {
        if (typeof window.prompt === 'function') {
          const result = window.prompt('请复制客服QQ号', qqValue);
          if (result !== null) {
            showToast();
          }
        } else {
          console.warn('当前环境不支持剪贴板复制或提示。');
        }
      };

      const handleCopy = (event: Event) => {
        event.preventDefault();
        event.stopPropagation();

        if (!qqValue) {
          return;
        }

        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          navigator.clipboard
            .writeText(qqValue)
            .then(showToast)
            .catch(() => {
              fallbackCopy();
            });
        } else {
          fallbackCopy();
        }
      };

      addListener(toggleBtn, 'click', togglePanel);

      if (closeBtn) {
        addListener(closeBtn, 'click', handleClose);
      }

      addListener(document, 'click', handleDocumentClick);
      addListener(document, 'keydown', handleKeydown);

      if (copyBtn) {
        addListener(copyBtn, 'click', handleCopy);
      }

      hideToast();

      // 首次自动展开逻辑
      const AUTO_OPEN_KEY = 'cs-auto-opened';
      let autoOpenTimer: number | null = null;
      let autoCloseTimer: number | null = null;

      const hasAutoOpened = localStorage.getItem(AUTO_OPEN_KEY);

      if (!hasAutoOpened) {
        // 3秒后自动打开
        autoOpenTimer = window.setTimeout(() => {
          openPanel();
          localStorage.setItem(AUTO_OPEN_KEY, 'true');

          // 打开后8秒自动关闭
          autoCloseTimer = window.setTimeout(() => {
            closePanel();
            autoCloseTimer = null;
          }, 8000);

          autoOpenTimer = null;
        }, 3000);
      }

      teardown = () => {
        closePanel();
        disposers.forEach((dispose) => dispose());

        if (toastTimer) {
          clearTimeout(toastTimer);
          toastTimer = null;
        }

        if (autoOpenTimer) {
          clearTimeout(autoOpenTimer);
          autoOpenTimer = null;
        }

        if (autoCloseTimer) {
          clearTimeout(autoCloseTimer);
          autoCloseTimer = null;
        }

        hideToast();

        teardown = null;
      };
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize, { once: true });
    } else {
      initialize();
    }

    document.addEventListener('astro:page-load', initialize);
    document.addEventListener('astro:before-swap', () => {
      if (typeof teardown === 'function') {
        teardown();
      }
    });
  })();
</script>
